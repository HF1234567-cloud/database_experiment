<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kzl.dao.TeacherMapper">
    <select id="selectCourseListByTeacher" resultType="com.kzl.entity.Course">
        SELECT s.id,s.courseName,s.collegeId,s.startDate,s.endDate,s.credits,s.optional,s.primaryAmount,s.selected,s.remark,s.academicYear,s.classPlace,s.classDate,s.teachEndDate,c.name collegeName,t.username teacherName
        FROM course s
        LEFT JOIN college c ON s.collegeId = c.id
        LEFT JOIN teacher t ON t.id=s.teacherId
        WHERE s.teacherId=#{teacherId}
        AND s.academicYear = #{academicYear}
    </select>

    <select id="selectStudentListByCourse" resultType="com.kzl.entity.StudentCourseRel">
        SELECT sc.id id,s.username studentName,c.courseName courseName,c.credits courseCredits,c.academicYear academicYear,sc.isQualified isQualified,sc.state state,c.teachEndDate teachEndDate,s.studentNumber studentNumber
        FROM student_course_rel sc
        LEFT JOIN course c ON c.id=sc.courseId
        LEFT JOIN student s ON s.id = sc.studentId
        WHERE c.teacherId=#{teacherId}
        <if test="academicYear != null and academicYear != ''">
            AND c.academicYear = #{academicYear}
        </if>
        <if test="courseId != null and courseId != ''">
            AND c.id = #{courseId}
        </if>
        <if test="studentName != null and studentName != ''">
            AND s.username LIKE concat('%',#{studentName},'%')
        </if>
    </select>

    <update id="updateStudentCourseRel" parameterType="com.kzl.entity.StudentCourseRel">
        UPDATE student_course_rel SET state=#{state},isQualified=#{isQualified},teacherId=#{teacherId}
        <if test="isQualified == '0'.toString()">,creditsRemark=#{creditsRemark}</if>
        WHERE id=#{id}
    </update>

    <select id="selectCourseAcademicYearList" resultType="com.kzl.entity.CourseAcademicYear">
        SELECT id,academicYear,state
        FROM course_academic_year
    </select>
    
   <select id="selectTeacherStatisList" resultType="com.kzl.entity.TeacherStatis">
        SELECT count(s.studentNumber) count,cu.name name
        FROM student_course_rel sc
            LEFT JOIN course c ON c.id=sc.courseId
            LEFT JOIN student s ON s.id = sc.studentId
            LEFT JOIN college cu ON cu.id = c.collegeId
        WHERE c.teacherId=#{teacherId} GROUP BY name
   </select>

    <select id="selectCourseCountList" resultType="com.kzl.entity.TeacherStatis">
        SELECT count(sc.studentId) count, c.courseName name
        FROM course c
        LEFT JOIN student_course_rel sc ON c.id = sc.courseId
        WHERE c.teacherId = #{teacherId}
        GROUP BY c.courseName
    </select>

    <select id="selectTeacherById" resultType="com.kzl.entity.Teacher">
        SELECT t.id, t.loginName, t.username, t.phone, t.email, t.roleId, t.collegeId,
               c.name collegeName, r.name roleName
        FROM teacher t
        LEFT JOIN college c ON t.collegeId = c.id
        LEFT JOIN role r ON t.roleId = r.id
        WHERE t.id = #{id}
    </select>

    <update id="updateTeacherProfile" parameterType="com.kzl.entity.Teacher">
        UPDATE teacher 
        SET username = #{username}, phone = #{phone}, email = #{email}
        WHERE id = #{id}
    </update>

    <select id="selectTeacherByIdAndPassword" resultType="com.kzl.entity.Teacher">
        SELECT id FROM teacher WHERE id = #{id} AND password = #{password}
    </select>

    <update id="updateTeacherPassword">
        UPDATE teacher SET password = #{newPassword} WHERE id = #{id}
    </update>
</mapper>